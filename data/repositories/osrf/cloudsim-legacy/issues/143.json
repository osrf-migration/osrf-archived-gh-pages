{"priority": "major", "kind": "bug", "repository": {"links": {"self": {"href": "data/repositories/osrf/cloudsim-legacy.json"}, "html": {"href": "#!/osrf/cloudsim-legacy"}, "avatar": {"href": "data/bytebucket.org/ravatar/{e799e7f6-0caa-464a-97f8-8605a37ebfb1}ts=python"}}, "type": "repository", "name": "cloudsim-legacy", "full_name": "osrf/cloudsim-legacy", "uuid": "{e799e7f6-0caa-464a-97f8-8605a37ebfb1}"}, "links": {"attachments": {"href": "data/repositories/osrf/cloudsim-legacy/issues/143/attachments_page=1.json"}, "self": {"href": "data/repositories/osrf/cloudsim-legacy/issues/143.json"}, "watch": {"href": "https://api.bitbucket.org/2.0/repositories/osrf/cloudsim-legacy/issues/143/watch"}, "comments": {"href": "data/repositories/osrf/cloudsim-legacy/issues/143/comments_page=1.json"}, "html": {"href": "#!/osrf/cloudsim-legacy/issues/143/task-does-not-stop"}, "vote": {"href": "https://api.bitbucket.org/2.0/repositories/osrf/cloudsim-legacy/issues/143/vote"}}, "reporter": {"display_name": "Hugo Boyer", "uuid": "{3d87874e-7099-4981-b04f-57f0272faa7d}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B3d87874e-7099-4981-b04f-57f0272faa7d%7D"}, "html": {"href": "https://bitbucket.org/%7B3d87874e-7099-4981-b04f-57f0272faa7d%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/21198da8539b599e3633017f5f5f8150d=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsHB-6.png"}}, "nickname": "hugomatic", "type": "user", "account_id": "557058:869c02bb-b246-4cdc-9db3-0064e8add185"}, "title": "Task does not stop", "component": null, "votes": 0, "watches": 0, "content": {"raw": "Simulator machine a better stop_sim.bash:\r\n\r\n\r\n\r\n```\r\n#!python\r\n\r\n#!/bin/bash\r\n\r\nMAX_TIME=30\r\necho `date` \"Stop sim - Begin\" >> /home/ubuntu/cloudsim/stop_sim.log\r\n. /usr/share/drcsim/setup.sh\r\n\r\nif timeout -k 1 2 gztopic list; then \r\n  LOG_PATH=`ps aux | grep gzserver | grep -m 1 record_path | cut -d = -f 3 | cut -d ' ' -f 1`/state.log\r\n  echo \"  Log file: $LOG_PATH\" >> /home/ubuntu/cloudsim/stop_sim.log \r\n  gzlog stop\r\n  # Let cleanup start, which pauses the world\r\n  sleep 5\r\n  while [ \"`timeout -k 1 1 gzstats -p 2>/dev/null |cut -d , -f 4 | tail -n 1`\" != \" F\" ]; do\r\n    sleep 1\r\n    if [ \"`ps aux | grep gzserver | wc -l`\" == \"1\" ]; then\r\n        echo \"  gzserver died, force exit\" >> /home/ubuntu/cloudsim/stop_sim.log\r\n        break\r\n    fi\r\n    # look for the name of the Log file\r\n    if [ \"`tail -n 1 $LOG_PATH`\" = \"</gazebo_log>\" ] ; then \r\n        echo \"  Log end tag detected\" >> /home/ubuntu/cloudsim/stop_sim.log\r\n        break \r\n    fi\r\n  done\r\nfi\r\nkillall -INT roslaunch || true\r\n\r\ntstart=$(date +%s)\r\n# Block until all ros process are killed\r\nwhile [ \"`ps aux | grep ros | wc -l`\" != \"1\" ]; do\r\n\r\n    tnow=$(date +%s)\r\n    if ((tnow-tstart>MAX_TIME)) ;then\r\n        break\r\n    fi\r\n\r\n    sleep 1\r\ndone\r\n\r\n# Kill all remaining ros processes\r\nkill -9 $(ps aux | grep ros | awk '{print $2}') || true\r\nkillall -9 gzserver || true\r\n```", "markup": "markdown", "html": "<p>Simulator machine a better stop_sim.bash:</p>\n<div class=\"codehilite language-python\"><pre><span></span><span class=\"ch\">#!/bin/bash</span>\n\n<span class=\"n\">MAX_TIME</span><span class=\"o\">=</span><span class=\"mi\">30</span>\n<span class=\"n\">echo</span> <span class=\"sb\">`date`</span> <span class=\"s2\">&quot;Stop sim - Begin&quot;</span> <span class=\"o\">&gt;&gt;</span> <span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">ubuntu</span><span class=\"o\">/</span><span class=\"n\">cloudsim</span><span class=\"o\">/</span><span class=\"n\">stop_sim</span><span class=\"o\">.</span><span class=\"n\">log</span>\n<span class=\"o\">.</span> <span class=\"o\">/</span><span class=\"n\">usr</span><span class=\"o\">/</span><span class=\"n\">share</span><span class=\"o\">/</span><span class=\"n\">drcsim</span><span class=\"o\">/</span><span class=\"n\">setup</span><span class=\"o\">.</span><span class=\"n\">sh</span>\n\n<span class=\"k\">if</span> <span class=\"n\">timeout</span> <span class=\"o\">-</span><span class=\"n\">k</span> <span class=\"mi\">1</span> <span class=\"mi\">2</span> <span class=\"n\">gztopic</span> <span class=\"nb\">list</span><span class=\"p\">;</span> <span class=\"n\">then</span> \n  <span class=\"n\">LOG_PATH</span><span class=\"o\">=</span><span class=\"sb\">`ps aux | grep gzserver | grep -m 1 record_path | cut -d = -f 3 | cut -d &#39; &#39; -f 1`</span><span class=\"o\">/</span><span class=\"n\">state</span><span class=\"o\">.</span><span class=\"n\">log</span>\n  <span class=\"n\">echo</span> <span class=\"s2\">&quot;  Log file: $LOG_PATH&quot;</span> <span class=\"o\">&gt;&gt;</span> <span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">ubuntu</span><span class=\"o\">/</span><span class=\"n\">cloudsim</span><span class=\"o\">/</span><span class=\"n\">stop_sim</span><span class=\"o\">.</span><span class=\"n\">log</span> \n  <span class=\"n\">gzlog</span> <span class=\"n\">stop</span>\n  <span class=\"c1\"># Let cleanup start, which pauses the world</span>\n  <span class=\"n\">sleep</span> <span class=\"mi\">5</span>\n  <span class=\"k\">while</span> <span class=\"p\">[</span> <span class=\"s2\">&quot;`timeout -k 1 1 gzstats -p 2&gt;/dev/null |cut -d , -f 4 | tail -n 1`&quot;</span> <span class=\"o\">!=</span> <span class=\"s2\">&quot; F&quot;</span> <span class=\"p\">];</span> <span class=\"n\">do</span>\n    <span class=\"n\">sleep</span> <span class=\"mi\">1</span>\n    <span class=\"k\">if</span> <span class=\"p\">[</span> <span class=\"s2\">&quot;`ps aux | grep gzserver | wc -l`&quot;</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;1&quot;</span> <span class=\"p\">];</span> <span class=\"n\">then</span>\n        <span class=\"n\">echo</span> <span class=\"s2\">&quot;  gzserver died, force exit&quot;</span> <span class=\"o\">&gt;&gt;</span> <span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">ubuntu</span><span class=\"o\">/</span><span class=\"n\">cloudsim</span><span class=\"o\">/</span><span class=\"n\">stop_sim</span><span class=\"o\">.</span><span class=\"n\">log</span>\n        <span class=\"k\">break</span>\n    <span class=\"n\">fi</span>\n    <span class=\"c1\"># look for the name of the Log file</span>\n    <span class=\"k\">if</span> <span class=\"p\">[</span> <span class=\"s2\">&quot;`tail -n 1 $LOG_PATH`&quot;</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;&lt;/gazebo_log&gt;&quot;</span> <span class=\"p\">]</span> <span class=\"p\">;</span> <span class=\"n\">then</span> \n        <span class=\"n\">echo</span> <span class=\"s2\">&quot;  Log end tag detected&quot;</span> <span class=\"o\">&gt;&gt;</span> <span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">ubuntu</span><span class=\"o\">/</span><span class=\"n\">cloudsim</span><span class=\"o\">/</span><span class=\"n\">stop_sim</span><span class=\"o\">.</span><span class=\"n\">log</span>\n        <span class=\"k\">break</span> \n    <span class=\"n\">fi</span>\n  <span class=\"n\">done</span>\n<span class=\"n\">fi</span>\n<span class=\"n\">killall</span> <span class=\"o\">-</span><span class=\"n\">INT</span> <span class=\"n\">roslaunch</span> <span class=\"o\">||</span> <span class=\"n\">true</span>\n\n<span class=\"n\">tstart</span><span class=\"o\">=</span><span class=\"err\">$</span><span class=\"p\">(</span><span class=\"n\">date</span> <span class=\"o\">+%</span><span class=\"n\">s</span><span class=\"p\">)</span>\n<span class=\"c1\"># Block until all ros process are killed</span>\n<span class=\"k\">while</span> <span class=\"p\">[</span> <span class=\"s2\">&quot;`ps aux | grep ros | wc -l`&quot;</span> <span class=\"o\">!=</span> <span class=\"s2\">&quot;1&quot;</span> <span class=\"p\">];</span> <span class=\"n\">do</span>\n\n    <span class=\"n\">tnow</span><span class=\"o\">=</span><span class=\"err\">$</span><span class=\"p\">(</span><span class=\"n\">date</span> <span class=\"o\">+%</span><span class=\"n\">s</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"p\">((</span><span class=\"n\">tnow</span><span class=\"o\">-</span><span class=\"n\">tstart</span><span class=\"o\">&gt;</span><span class=\"n\">MAX_TIME</span><span class=\"p\">))</span> <span class=\"p\">;</span><span class=\"n\">then</span>\n        <span class=\"k\">break</span>\n    <span class=\"n\">fi</span>\n\n    <span class=\"n\">sleep</span> <span class=\"mi\">1</span>\n<span class=\"n\">done</span>\n\n<span class=\"c1\"># Kill all remaining ros processes</span>\n<span class=\"n\">kill</span> <span class=\"o\">-</span><span class=\"mi\">9</span> <span class=\"err\">$</span><span class=\"p\">(</span><span class=\"n\">ps</span> <span class=\"n\">aux</span> <span class=\"o\">|</span> <span class=\"n\">grep</span> <span class=\"n\">ros</span> <span class=\"o\">|</span> <span class=\"n\">awk</span> <span class=\"s1\">&#39;{print $2}&#39;</span><span class=\"p\">)</span> <span class=\"o\">||</span> <span class=\"n\">true</span>\n<span class=\"n\">killall</span> <span class=\"o\">-</span><span class=\"mi\">9</span> <span class=\"n\">gzserver</span> <span class=\"o\">||</span> <span class=\"n\">true</span>\n</pre></div>", "type": "rendered"}, "assignee": null, "state": "resolved", "version": null, "edited_on": null, "created_on": "2013-06-11T02:30:22.799279+00:00", "milestone": null, "updated_on": "2013-06-14T07:24:50.185469+00:00", "type": "issue", "id": 143}